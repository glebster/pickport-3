# 06 — Архитектура (local‑first PWA + FastAPI)

## Общая схема

- **Frontend:** Svelte 5, PWA, offline‑first, локальная база (IndexedDB/SQLite), кэш вложений.
- **Локальный контур:** вся пользовательская база и история изменений — на устройстве.
- **Backend:** FastAPI как прокси для AI, конфиг‑сервис и авторизация устройств; синхронизация — опционально.
- **Облачный контур:** только метаданные и технические токены; содержимое записей не хранится без явного opt‑in.
- **AI‑слой:** анализ текста/фото/URL и семантический поиск через прокси.

## Архитектурные принципы

- **Source of truth** — локальная база пользователя.
- **Offline‑first** — всё работает без сети, AI подключается при онлайне.
- **Минимизация облака** — сервер хранит только технические данные без контента.
- **Конфиг‑ориентированность** — формы и рецепты управляются конфигом.

## Основные компоненты backend

- `auth` — устройства, сессии и привязки user_id ↔ device_id.
- `config` — каталог базовых рецептов/категорий (без пользовательского контента).
- `ai` — проксирование запросов и семантический поиск.
- `telemetry` — метрики, лимиты, биллинг.
- `sync` (опционально) — зашифрованная синхронизация между устройствами.

## Синхронизация

- по умолчанию записи живут локально и не уходят на сервер;
- при включении режима синхронизации — отправляется только **зашифрованный** контент;
- фоновые задачи синхронизируют изменения;
- при конфликте — стратегия «последнее изменение с логом».
Списки и группы синхронизируются тем же механизмом, чтобы сохранять целостность связей.

## Безопасность и приватность

- шифрование вложений на стороне клиента (по возможности);
- авторизация устройств и управление сессиями;
- экспорт/удаление всех данных пользователем;
- подробности разделения контуров — в [18-storage-model.md](18-storage-model.md).

## Конфигурация рецептов

- базовые рецепты и поля приходят из backend через `/api/config/*` (без пользовательского контента);
- пользовательские рецепты живут локально и синхронизируются только при opt‑in;
- фронт строит форму динамически;
- изменение рецепта не требует деплоя фронта.
