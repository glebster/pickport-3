# 18 — Модель хранения: локальная база и облачный контур

Документ описывает, **что именно хранится локально на устройстве**, а что находится в облаке. Цель — обеспечить контроль за данными и исключить хранение персонального контента на сервере.

## 1. Два контура хранения

### Локальный контур (у пользователя)
Хранится **вся пользовательская база**:

- **Записи (Entries)**: полный набор полей, заметки, суммы, места, теги, люди, вложения.
- **AI-данные**: исходные запросы/ответы, извлечённые поля, confidence, черновики.
- **Структура данных**: рецепты, поля, категории, пользовательские расширения.
- **Сущности**: пользователи, пространства (spaces), группы/шаринг, списки, напоминания.
- **История изменений**: версии, локальные логи действий, статус синхронизаций.

Шифрование локальной базы и экспортов — опционально и остаётся на стороне пользователя; серверные требования к этому отсутствуют.

### Облачный контур (наш сервер)
Хранится **только то, что необходимо для работы сервиса**, без содержимого записей:

- **UUID пользователя** (user_id) и **UUID устройства** (device_id).
- **Привязки устройств** к user_id (device mapping).
- **Авторизация устройства**: публичный ключ устройства, статусы доступа, время последнего входа.
- **Техническая телеметрия** по ИИ: request_id, модель, дата, токены, latency, ошибки — **без текста запроса/ответа**.
- **Технические токены**: refresh/сессии, ключи для авторизации устройства (без PII).
- **Биллинг/лимиты**: план, квоты, счётчики использования (без содержимого записей).

> В облаке **нет**: текстов записей, заметок, вложений, фото, сканов, ai_raw и любых содержательных данных пользователя.

## 2. Сквозные UUID и контроль данных

- **Каждая запись имеет UUID** (entry_id), который генерируется локально и хранится только в локальной базе.
- **Пользователь (user_id)** — это **абстрактный UUID**, без имени/почты/телефона.
- **Пространства и группы** (space_id, group_id) также локальные; облако их не хранит, пока не включены сценарии совместной работы.

Это позволяет иметь единый идентификатор для записей и пользователей, не передавая персональные данные на сервер.

## 3. Как проходит авторизация: устройство vs пользователь

Мы разграничиваем два уровня:

1. **Пользователь = UUID** (идентичность).
2. **Устройство = UUID** (конкретная установка).

Авторизация строится вокруг устройства, а пользователь — это «контейнер данных», который может быть перенесён на новое устройство.

### Новый пользователь (первый запуск)
- Приложение генерирует `user_id` и `device_id` локально.
- Сервер получает только `user_id` и `device_id` для регистрации устройства.

### Новое устройство для существующего пользователя
- Пользователь переносит локальную базу (или ключи) на новое устройство.
- Новое устройство получает **тот же** `user_id`, но **новый** `device_id`.
- Сервер связывает новый `device_id` с тем же `user_id` (через QR/код/подписанный токен).

Таким образом мы **авторизуем устройство**, а не «человека» по персональным данным.

## 4. Что хранить на сервере, чтобы не усложнять жизнь

Минимальный набор серверной логики:

- Реестр устройств (`user_id` ↔ `device_id`).
- Сессии/refresh‑токены на устройство.
- Метаданные ИИ-использования (без контента).

Этого достаточно для:

- лимитов и биллинга,
- контроля доступа устройств,
- метрик качества и затрат.

## 5. Границы и будущие опции

Если когда-либо понадобится облачное хранение (например, синхронизация между устройствами), это **отдельный режим** с явным согласием пользователя и прозрачным описанием данных, которые будут отправлены.

## 6. Режимы работы: офлайн и онлайн

### Офлайн (без интернета)
Доступно:
- ручной ввод записей и редактирование полей;
- локальный просмотр по категориям/подкатегориям, спискам, фильтрам;
- локальный поиск по тексту в своих записях.

Недоступно:
- AI‑бот/чат, AI‑поиск;
- автоматическое распознавание и шаг AI (шаг 1) в визарде;
- телеметрия и биллинг‑метрики.

### Онлайн (с интернетом)
Доступно всё из офлайна плюс AI‑возможности:
- шаг AI (извлечение из текста/фото/URL);
- AI‑чат и AI‑поиск.

При использовании AI‑возможностей сервер фиксирует только техническую телеметрию (request_id, модель, токены, дата, ошибки) без содержимого запросов/ответов.

## 7. Что платно/бесплатно (AI‑режим)

Базовая логика:
- **без AI** — доступна бесплатно (ручной ввод и локальные функции);
- **AI‑функции** — связаны с затратами на модели, поэтому могут иметь лимиты/тарифы.

Конкретные лимиты/планы описываются в монетизации и могут меняться без влияния на локальные данные.

## 8. Интернет для старта и авторизации устройства

- Для первичной регистрации устройства и привязки к user_id нужен интернет.
- Дальше устройство может работать офлайн, если пользователь не включает AI‑режим.
