# Архитектура PickPock (MVP) и развитие API

## 1. Общая схема

| Слой            | Технологии                                                          | Ответственность                                                                                   |
| --------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| Клиент          | SvelteKit 5 (SPA/PWA), TypeScript, Tailwind, IndexedDB              | UI, визард записей, чат и поиск, локальный кеш и офлайн-режим                                      |
| API/Backend     | FastAPI, Uvicorn/Gunicorn, Celery, Redis, OpenAPI                   | REST/WebSocket API, бизнес-логика, очереди AI/медиа, выдача конфигов/схем (`/api/config/*`)        |
| Хранилище       | PostgreSQL (JSONB, PostGIS, pgvector) + S3/MinIO для файлов         | Таблицы `entries`, `recipes`, `users`, `reminders`, `sync_log`, хранение вложений и AI метаданных |
| AI-интеграция   | OpenRouter (gpt-4o-mini) / локальные модели (roadmap)               | Анализ текста/фото/URL, чат и семантический поиск                                                 |

### Поток данных

| Шаг | Что происходит                                                                                                                           |
| --- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Пользователь создаёт запись → фронт вызывает клиент `entriesApi` (SvelteKit → FastAPI).                                                  |
| 2   | Клиент собирает payload (JSON + файлы) и отправляет `fetch('https://api.pickpock.app/v1/entries')`.                                      |
| 3   | FastAPI валидирует семантику (`Action/Object`), сжимает изображения через Celery/Sharp, формирует `Entry` модель и пишет в PostgreSQL.   |
| 4   | PostgreSQL подтверждает запись, FastAPI возвращает JSON → фронт → IndexedDB/сторы.                                                       |

Для чтения данных фронт всегда обращается к FastAPI `/api/v1/...`, поэтому авторизацию, версии и rate-limit можно централизованно применять на backend’е.

## 2. Ключевые модули

| Блок                  | Описание                                                                                                                     |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| Semantic core         | `src/lib/core/semantic.ts` — перечисления допустимых `Action/Object`, проверка `isValidSemantic`.                            |
| Config (локальный)    | `src/lib/config/fields.ts`, `recipes*.json/ts` — справочник полей/рецептов, AI-настроек и категорий.                         |
| FastAPI clients       | `src/lib/services/*` — fetch-клиенты к FastAPI (`entriesApi`, `aiApi`, `configApi`, `filesApi`).                             |
| Backend (FastAPI)     | `backend/app/api/v1/*` — REST/WebSocket роуты (entries, recipes, ai, sync, reminders), Celery задачи, выдача JSONSchema.     |
| Storage layer         | `backend/app/models/*` — SQLAlchemy/SQLModel сущности, миграции Alembic, репозитории на PostgreSQL.                           |
| AI/киви               | `/api/ai/*` — анализ текста/фото/URL, чат и подсказки поиска (FastAPI → OpenRouter/Celery).                                   |
| Dashboard/analytics   | `/api/dashboard/stats`, `/api/entries/stats` — быстрые агрегаты в FastAPI (PostgreSQL + pgvector + materialized views).      |

### Поля и рецепты

| Сущность                 | Структура / примечания                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `FieldDef`               | `id`, `label`, `type` (text/textarea/number/money/select/tags/people/date/time/geo/json/url), `section` (base/extended), `placeholder`, `serialize` (string/number/json), `isArray`, `aiKey`, `min/max/step`, `rows`.                                                                                                                                                                                                                                                                                                  |
| Базовые поля             | `title`, `date`, `tags`, `note`, `attachments`, `amount`, `currency`, `category`, `subcategory`.                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Расширенные поля         | Гео (`placeText`, `address`, `geo`), люди (`people`), параметры (`rating`, `quantity`, `unit`, `url`, `recurrence`, `distance`, `calories`, `duration`, `startTime`, `endTime`), адресные подробности (`country`, `region`, `zip`, `street`, `building`, `apartment`), финансы (`merchant`, `store`, `cardLast4`, `iban`, `account`, `invoice`, `billId`), контакты (`phone`, `email`, `website`), контекст (`mood`, `weather`, `temperature`, `participants`, `device`, `project`, `context`, `time`, `numberField`). |
| Recipe                   | `id`, `action`, `object`, `label`, `icon`, `description`, `category`, `subcategory`, `color`, `enabled`, `sortOrder`, `form.fields`, `form.required`, `ai.mode`, `ai.extract`, `ai.promptTemplate`.                                                                                                                                                                                                                                                                                                                    |
| Категории                | Загружаются из `recipes.built.json`: содержат label/icon + список рецептов, используются для группировки в визарде.                                                                                                                                                                                                                                                                                                                                                                                                    |
| Пользовательские рецепты | Хранятся в PB (`user_recipes`), синхронизируются через `/api/recipes`, поддерживают включение/выключение через `recipe_settings`.                                                                                                                                                                                                                                                                                                                                                                                      |

### Пайплайн создания записей

| Канал                     | Процесс                                                                                                                             |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| Визард                    | Пользователь выбирает рецепт → UI строится из `FieldDef` → данные отправляются через `createEntry` (`/api/entries`).                |
| Свободный текст           | `POST /api/ai/analyze` анализирует текст → возвращает `action/object/title/note/...` → пользователь подтверждает → `createEntry`.   |
| Фото                      | `POST /api/ai/analyze` с прикреплённым изображением (sharp → Base64) → AI распознаёт чек/товар → предлагает запись → `createEntry`. |
| URL                       | `POST /api/ai/analyze` подтягивает страницу, извлекает содержимое и формирует запись (товар, место).                                |
| Повтор/быстрое добавление | `POST /api/entries/replay` — дублирует существующую запись с возможностью изменения полей.                                          |

### Роль AI

| Задача              | Роут / результат                                                                                                                                       |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Анализ текста/фото  | `/api/ai/analyze` — извлекает `action/object/title/note/amount` и описательные метаданные, поддерживает множественные записи.                          |
| Чат/общение         | `/api/ai/chat` — пользователь спрашивает ИИ: “Кому я одалживал зарядку?” → сервис получает 50 записей и формирует ответ + предложенные фильтры/записи. |
| Семантический поиск | `/api/ai/search` — похож на чат, но выдаёт подсказки для фильтров/ID записей, чтобы быстро найти нужное.                                               |
| OCR/описания        | `/api/ai/ocr`, `/api/ai/describe-file` — расшифровывают чеки, описывают изображения, сохраняют метаданные в `file_insights` для поиска.                |

### Общение с ИИ и поиск

| Сервис                       | Особенности                                                                                                                                                                   |
| ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `/api/ai/chat`               | Общение в чате: AI анализирует контекст записей, отвечает на вопросы, подсказывает фильтры и записи; ответы возвращаются в JSON (`response`, `suggestedFilters`, `entryIds`). |
| `/api/ai/search`             | Семантический поиск без чата: AI предлагает фильтры и записи, чтобы пользователь быстро нашёл нужное событие (“тот ресторан с пастой”).                                       |
| `/api/search` (классический) | В планах расширить `GET /api/entries` с фильтрами + `/api/entries/search` для full text; AI-подсказки дополняют, но не заменяют deterministic поиск.                          |

## 3. Текущие публичные эндпоинты

| Метод          | Роут                                 | Назначение                                                                                     |
| -------------- | ------------------------------------ | ---------------------------------------------------------------------------------------------- |
| GET            | `/api/v1/entries`                    | Список записей (фильтры: userId, status, dateFrom, dateTo, includeDeleted).                    |
| POST           | `/api/v1/entries`                    | Создание записи + загрузка вложений, AI-мета.                                                  |
| GET/PUT/DELETE | `/api/v1/entries/[id]`               | Чтение / обновление / удаление записи.                                                         |
| GET            | `/api/files/entries/[id]/[filename]` | Отдача файлов из object storage (через FastAPI, с кешированием).|
| POST           | `/api/ai/analyze`                    | AI-анализ текста/URL/изображений.                              |
| POST           | `/api/ai/chat`                       | Диалоговый помощник по личной истории.                         |
| POST           | `/api/ai/search`                     | AI-подсказки для поиска.                                       |
| GET            | `/api/dashboard/stats`               | Статистика (расходы/доходы/категории/места/планы).             |
| GET/POST       | `/api/recipes`                       | Получение / создание пользовательских рецептов.                |
| PUT/DELETE     | `/api/recipes/[id]`                  | Обновление / удаление рецептов.                                |
| GET/PUT        | `/api/recipes/settings`              | Сохранение списка включенных рецептов.                         |
| GET/PUT        | `/api/settings`                      | Настройки AI (включено/выключено, модели, валюта).             |

Почти все роуты возвращают пустые массивы или 403 при отсутствии прав, поэтому MVP можно демонстрировать без логина; при переходе на полноценный прод — включаем JWT/WebAuthn на FastAPI.

---

# План развития API

Цель: убрать жесткие связки из фронта (fields/recipes) и подготовиться к будущим функциям (напоминания, шэринг, голос).

## 1. Конфигурация через API

| Роут                         | Состояние | Детали                                                                                                                             |
| ---------------------------- | --------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `GET /api/config/fields`     | **Новый** | Выдаёт `FIELD_DEFS` (type, label, section, serialize, options). Источник — таблица `field_defs` в PostgreSQL или статический JSON. |
| `GET /api/config/recipes`    | **Новый** | Возвращает полный каталог (дефолтные + пользовательские) с категориями, цветами, AI-настройками.                                   |
| `GET /api/config/categories` | **Новый** | Метаданные категорий/подкатегорий (label, icon).                                                                                   |

Фронт будет сначала загружать конфиги, затем строить визард. Это позволит править формы без деплоя.

## 2. Расширение Entries API

| Возможность               | Описание                                                                                       |
| ------------------------- | ---------------------------------------------------------------------------------------------- |
| Расширенные параметры     | `page`, `perPage`, `sort`, `action`, `object`, `category`, `people`, `tags`, `hasAttachments`. |
| `GET /api/entries/search` | Лёгкий поиск (строка → список id, title, date) без загрузки всех полей.                        |
| `GET /api/entries/stats`  | Компактные агрегаты (суммы/кол-во по фильтрам), чтобы не тянуть полный список.                 |
| `GET /api/entries/stream` | SSE/WebSocket-стрим, чтобы “важные записи всплывали сами” и UI обновлялся в реальном времени.  |

## 3. Справочники и подсказки

| Роут                               | Описание                                    |
| ---------------------------------- | ------------------------------------------- |
| `GET /api/dictionaries/tags`       | Чаще всего используемые теги.               |
| `GET /api/dictionaries/people`     | Автодополнение людей (по `entries.people`). |
| `GET /api/dictionaries/places`     | Последние места + координаты.               |
| `GET /api/dictionaries/currencies` | Из `settings` (дефолт + доступные).         |

Эти данные нужны для AI-подсказок, автозаполнений и быстрой аналитики.

## 4. Напоминания и планы (roadmap)

| Элемент               | Описание                                                                        |
| --------------------- | ------------------------------------------------------------------------------- |
| Коллекция `reminders` | Поля `entryId`, `type`, `dueDate`, `channel`, `status`.                         |
| Роуты                 | `GET/POST/PUT/DELETE /api/reminders`.                                           |
| Интеграция с PWA      | `POST /api/notifications/subscribe` (web-push), `POST /api/notifications/test`. |

## 5. Импорт (QR/голос/повторения)

| Роут                       | Описание                                                             |
| -------------------------- | -------------------------------------------------------------------- |
| `POST /api/import/qr`      | Принимает расшифрованный текст или файл, возвращает `EntryFormData`. |
| `POST /api/import/voice`   | Текст после STT + анализ (можно переиспользовать `ai/analyze`).      |
| `POST /api/entries/replay` | Быстрое дублирование записи/рецепта.                                 |

## 6. Профиль и аккаунт

| Роут                               | Описание                                                   |
| ---------------------------------- | ---------------------------------------------------------- |
| `GET /api/profile`                 | Инфо пользователя (имя, email, timezone).                  |
| `PUT /api/profile`                 | Обновление имени, аватара, настроек UI.                    |
| `GET/POST /api/profile/security`   | Смена пароля, 2FA, список устройств.                       |
| `GET/PUT /api/profile/preferences` | Пользовательские предпочтения (дефолтные фильтры, модули). |
| `GET /api/profile/activity`        | История входов и действий.                                 |

Нужны коллекции `users`, `user_preferences`, audit лог.

## 7. AI-инфраструктура

| Роут                                          | Описание                                                     |
| --------------------------------------------- | ------------------------------------------------------------ |
| `POST /api/ai/jobs` / `GET /api/ai/jobs/[id]` | Асинхронные задачи анализа (batch фото/текст).               |
| `GET /api/ai/usage`                           | Статистика токенов и лимитов по моделям.                     |
| `GET/PUT /api/ai/settings`                    | Выбор моделей (text/vision), персональные лимиты.            |
| `GET /api/ai/cache`                           | Последние результаты анализа (для повторного использования). |
| `POST /api/ai/describe-file`                  | Генерация подписи и тегов для вложения.                      |
| `POST /api/ai/ocr`                            | Структурированный OCR (чеки, документы).                     |

## 8. Медиа и файлы

| Роут                          | Описание                                                            |
| ----------------------------- | ------------------------------------------------------------------- |
| `GET /api/files`              | Список файлов с фильтрами и метаданными (AI-описание, теги, место). |
| `POST /api/files/upload-temp` | Временное хранилище до выбора рецепта.                              |
| `DELETE /api/files/[id]`      | Ручное удаление/освобождение места.                                 |
| `POST /api/media/process`     | Сервис преобразований (thumbnail, webp, OCR, EXIF).                 |

## 9. Экспорт, шэринг и автоматика

| Роут/блок                                                     | Описание                                              |
| ------------------------------------------------------------- | ----------------------------------------------------- |
| `GET /api/export` / `POST /api/export/request`                | Выгрузка архива (JSON/ZIP).                           |
| `GET/POST /api/spaces` + `/api/spaces/[id]/entries`           | Семейный доступ и общие списки.                       |
| `GET /api/activity`                                           | Аудит действий (особенно при нескольких участниках).  |
| `POST /api/webhooks`                                          | Подключение внешних автоматизаций (Notion, Telegram). |
| `POST /api/import/voice` / `/qr` / `POST /api/entries/replay` | Быстрые сценарии из раздела 5.                        |
| `POST /api/lists` / `/lists/share`                            | Умные списки подарков, желаний, QR-приглашения.       |
| `POST /api/support/ticket`                                    | Канал обратной связи с командой.                      |

## 10. Доступ и авторизация

| Шаг             | Описание                                                                         |
| --------------- | -------------------------------------------------------------------------------- |
| Версионирование | Ввести `/api/v1/...`.                                                            |
| Auth-роуты      | Добавить `/api/auth/*` (FastAPI + PostgreSQL `users`), поддержать JWT/refresh, WebAuthn. |
| Enforcement     | Все существующие роуты переводятся на проверку `pb.authStore`.                   |
| Защита          | Логирование и rate-limiting (Cloudflare/middleware), health-check `/api/status`. |

## 11. Роли, уведомления и интеграции

| Роут/блок                                                                   | Описание                                                   |
| --------------------------------------------------------------------------- | ---------------------------------------------------------- |
| `GET/PUT /api/spaces/[id]/members`                                          | Управление ролями (owner/editor/viewer) и правами.         |
| `GET /api/permissions`                                                      | Быстрый ответ, что может пользователь в текущем контексте. |
| `GET /api/notifications` / `POST /api/notifications/mark-read`              | Inbox событий (AI завершил анализ, напоминание).           |
| `POST /api/notifications/subscribe` / `GET/PUT /api/notifications/settings` | Web-push и выбор каналов.                                  |

## 12. Процесс внедрения

| Шаг | Содержание                                                                                                                    |
| --- | ----------------------------------------------------------------------------------------------------------------------------- |
| 1   | **Конфиги через API** — миграции `field_defs`, `recipe_defaults`, обновление фронта.                                          |
| 2   | **Расширенный entries/search/stats** — новая фильтрация, пагинация, словари.                                                  |
| 3   | **Справочники, импорт, медиа-сервис** — `files`, `media/process`, `ai/jobs`.                                                  |
| 4   | **Reminders/notifications** — новые коллекции + push/webhooks.                                                                |
| 5   | **Auth & профиль** — `users`, `/api/profile`, `/api/auth`, база для тарифов.                                                  |
| 6   | **Медиа и очереди** — довести `media/process`, файловый сервис, Celery/Redis мониторинг.                                      |
| 7   | **Шэринг/экспорт/автоматика** — `spaces`, webhooks, экспорт, интеграции, демо-маршруты, оффлайн-синхронизация, публичные API. |
| 8   | **Штрихкоды и оффлайн** — расширенный импорт QR/штрихкодов, улучшенный `/api/sync/*`.                                         |

## 13. Оффлайн-синхронизация

| Роут/правило          | Описание                                                                |
| --------------------- | ----------------------------------------------------------------------- |
| `GET /api/sync/state` | Состояние версии данных (hash, timestamp).                              |
| `POST /api/sync/push` | Пачка локальных изменений (создания/редактирования/удаления).           |
| `GET /api/sync/pull`  | Дельты записей, рецептов, справочников для восстановления оффлайн-базы. |
| Разрешение конфликтов | LWW или журнал изменений, который ведётся в PostgreSQL (`entry_changes`). |

## 14. База данных и масштабирование

| Контур                        | Коллекции / таблицы                                                                                                  | Особенности                                                                          |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| **Записи и контекст**         | `entries`, `entry_files` (связь многие-ко-многим), `entry_changes` (журнал), индексы по `spaceId`, `date`, `status`. | Поля `spaceId`, `listId`, `reminderId`, `syncedAt`, `version`, `deletedAt`.          |
| **Конфиги и рецепты**         | `field_defs`, `recipe_defaults`, `recipe_settings`, `user_recipes`.                                                  | Отдельные коллекции для дефолтов и пользовательских настроек, JSON-схемы с версиями. |
| **Справочники/подсказки**     | `tags`, `people`, `places_cache`.                                                                                    | Обновляются задачами, чтобы не нагружать `entries`.                                  |
| **AI и медиа**                | `ai_jobs`, `ai_usage_log`, `file_insights` (описания вложений), `media_queue`.                                       | Хранить только метаданные; файлы — в object storage.                                 |
| **Напоминания и уведомления** | `reminders`, `notifications`, `notification_tokens`.                                                                 | Индексы по `dueDate`, `status`, `userId`.                                            |
| **Профиль и биллинг**         | `users`, `user_preferences`, `subscriptions`, `usage_stats`, `payments`.                                             | Разделяем глобальные настройки (`app_settings`) и пользовательские.                  |
| **Шэринг и списки**           | `spaces`, `space_members`, `lists`, `list_items`.                                                                    | Везде есть `spaceId`; вводим роли (owner/editor/viewer).                             |
| **Интеграции, демо, саппорт** | `integrations`, `webhooks`, `support_tickets`, `demo_state`, `feedback`, `telemetry`.                                | Логируем действия и статусы, чтобы отслеживать качество AI.                          |
| **Синхронизация и аудит**     | `sync_log`, `activity_log`, `data_repairs`.                                                                          | Позволяет CRDT/дельты для оффлайна и автоматические проверки.                        |

Технические принципы:

| Принцип      | Описание                                                                                         |
| ------------ | ------------------------------------------------------------------------------------------------ |
| Миграции     | Все изменения схемы идут через `pb_migrations/*`, порядок версий фиксирован в Git.               |
| Индексы      | На всех фильтруемых полях (date/status/spaceId/tag) + уникальные ограничения (`userId+spaceId`). |
| Аналитика    | Тяжёлые запросы выносятся в ClickHouse/BigQuery или materialized views PostgreSQL.                |
| Бэкапы       | Регулярные дампы + опциональная реплика для чтения (cron).                                       |
| Логи AI      | Usage хранится отдельно, чтобы не перегружать основную БД.                                       |
| Шардирование | Поддерживаем `spaceId` во всех коллекциях, чтобы при необходимости делить данные.                |

### PostgreSQL профиль

| Возможность       | Применение в PickPock                                                                                          |
| ----------------- | -------------------------------------------------------------------------------------------------------------- |
| JSONB поля        | Хранение `extras`, AI-метаданных, динамических полей рецептов без отдельной схемы.                             |
| Расширения        | `pg_trgm` и `fulltext` для поиска “тот ресторан с пастой”, `pgvector` для embedding-поиска записей.            |
| Индексирование    | Составные индексы (`spaceId`, `date`), GIN для JSONB/array-полей (`tags`, `people`).                           |
| Репликация/бэкапы | Используем managed Postgres (Supabase/Neon) или собственный кластер с WAL-бэкапами и read-replicas.            |
| Миграции          | Alembic/SQLAlchemy завязаны на `pb_migrations` (или отдельные scripts) для единообразных релизов.              |
| Геоданные         | `PostGIS` для хранения координат, поиска ближайших мест, фильтра “где я ел?”.                                  |
| Очереди/события   | `LISTEN/NOTIFY` можно использовать как источник событий для realtime-сервиса (альтернатива WebSocket-серверу). |

## 15. Структура проекта и слои

Рекомендуемая организация каталогов (в дополнение к существующему `src/lib`):

| Папка/слой             | Содержание                                             | Комментарии                                       |
| ---------------------- | ------------------------------------------------------ | ------------------------------------------------- |
| `src/lib/core`         | Семантическое ядро, константы, базовые типы.           | Файл `core/semantic.ts`.                          |
| `src/lib/config`       | Конфиги рецептов, полей, категорий, intent.            | `recipes.ts`, `fields.ts`, `category-mapping.ts`. |
| `src/lib/components/*` | UI, layout, entry-компоненты, AI-примитивы.            | Делятся на ui/layout/feature.                     |
| `src/lib/pocketbase`   | Клиенты PB (entries, recipes, settings) + SDK.         | Уже используется как data-layer.                  |
| `src/lib/data`         | Сбощик типов и клиенты (`pocketbase-client`, `types`). | Общий доступ к данным.                            |
| `src/lib/types`        | TS-типы (`entry`, `ai`, `message`).                    | Импортируются в компонентах и API.                |
| `src/lib/utils`        | Форматирование, логгер, helpers.                       | `format.ts`, `entry-relations.ts`.                |
| `src/lib/server`       | Hooks/middleware для серверных роутов.                 | Расширяется по мере роста API.                    |
| `src/routes/api/*`     | SvelteKit endpoints — thin контроллеры.                | Вызывают `src/lib/pocketbase/*`.                  |
| `scripts/`             | CLI-утилиты (миграции, тестовые вызовы API).           | Уже используется.                                 |
| `frontend/`            | Полный SvelteKit 5 проект (src, static, tests).        | Сохраняем стандартную структуру SvelteKit.        |
| `backend/`             | FastAPI приложение + Celery/worker код.                | Изолируем серверную часть.                        |
| `docker/`              | Dockerfile, docker-compose, env и Makefile.            | Одинаковый запуск локально и на VM.               |

Дополнительно планируемые каталоги (можно добавлять по мере необходимости):

| Папка/слой                  | Кого касается                                                | Комментарии                                |
| --------------------------- | ------------------------------------------------------------ | ------------------------------------------ |
| `src/lib/modules/<feature>` | Фиче-модули со стором/компонентами (entries, reminders, ai). | Пока пусто, но удобно для масштабирования. |
| `src/lib/repositories`      | Обёртки между FastAPI и UI (для кеширования/моков).          | Появится при росте доменных сервисов.      |
| `backend/services/*`        | Бизнес-логика FastAPI, отделяет роуты от БД.                 | Создадим при переходе на FastAPI.          |

> Примечание: все каталоги вида `src/lib/*`, `src/routes/*`, `src/service-worker.ts` относятся к приложению внутри `frontend/`. Backend оперирует собственными путями (`backend/app/*`) и не делит `src` с фронтом.

### Практический план реорганизации

```
pickpock/
├─ frontend/          # текущий SvelteKit + PWA (без изменений структуры внутри)
├─ backend/           # FastAPI + PostgreSQL миграции + Celery worker
├─ docker/            # compose, Dockerfile, .env.example, Makefile
├─ scripts/           # миграции PB, вспомогательные cli
└─ docs/              # вся документация (архитектура, продукт и т.д.)
```

1. Выносим весь проект SvelteKit в корневую папку `frontend/` (структура `src/lib/...` остаётся штатной для Svelte 5).
2. Создаём `backend/` c FastAPI, Celery worker и миграциями (Alembic).
3. Общие типы синхронизируем через генерацию (`pnpm run generate:types` из OpenAPI/JSON Schema) — без отдельного packages.
4. Корневой `package.json` может остаться простым, достаточно отдельных `frontend/package.json` и `backend/pyproject.toml`.
5. `docker/compose.yml` использует build-контексты `../frontend` и `../backend`, поэтому dev/prod работают одинаково.

#### `frontend/` (Svelte 5)

| Папка                       | Назначение                                                           | Заметки по реализации                              |
| --------------------------- | -------------------------------------------------------------------- | -------------------------------------------------- |
| `src/routes`                | Страницы, layout’ы, server/load функции SvelteKit.                   | Каждая страница импортирует фичи из `lib/modules`. |
| `src/lib/modules/*`         | Фичи (entries, recipes, ai, catalog). Компоненты + stores + actions. | Используем runes (`$state`, `$effect`) локально.   |
| `src/lib/components/ui`     | Переиспользуемые UI-примитивы (Button, Card, Modal).                 | Без бизнес-логики, только стили и анимации.        |
| `src/lib/components/layout` | Хедеры, сайдбары, shell.                                             | Делим на public/private layout.                    |
| `src/lib/services`          | Клиенты API: `entriesApi`, `aiApi`, `syncApi`.                       | Оборачиваем fetch, retries, error handling.        |
| `src/lib/stores`            | Глобальные Svelte stores (`user`, `sync_state`, `recipes`).          | Инициализируются в layout load.                    |
| `src/lib/server`            | Middleware, hooks, auth/session helpers.                             | Используется только на серверных роутерах.         |
| `src/lib/utils`             | Форматирование, money, ai helpers.                                   | Покрываем unit-тестами.                            |
| `src/service-worker.ts`     | PWA логика, background sync, push.                                   | Сборка через Vite SW plugin.                       |
| `tests/frontend`            | Vitest + Playwright для UI.                                          | Повторяет структуру модулей.                       |

#### `backend/` (FastAPI)

| Папка/слой      | Назначение                                                | Детали                                                                                    |
| --------------- | --------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| `app/main.py`   | Точка входа FastAPI, подключение роутеров.                | Импортирует `create_app()` из `app/core/app.py`.                                          |
| `app/api/v1`    | Роуты (`entries.py`, `recipes.py`, `ai.py`, `sync.py`).   | Каждый файл регистрирует `APIRouter`, использует зависимость `Depends(get_db)` и сервисы. |
| `app/schemas`   | Pydantic-модели (EntrySchema, RecipeSchema, FieldSchema). | Синхронизируем через OpenAPI/JSON Schema генерацию для фронтенда.                         |
| `app/models`    | SQLAlchemy/SQLModel сущности.                             | Поддержка Postgres JSONB, enum, индексы.                                                  |
| `app/services`  | Бизнес-логика (EntriesService, AIService, SyncService).   | Роуты не содержат тяжелой логики.                                                         |
| `app/core`      | Конфиг (settings, logging, security, auth).               | `.env` читается через `pydantic BaseSettings`.                                            |
| `app/db`        | Подключение к БД, сессии, миграции (Alembic).             | `alembic/` хранит версии.                                                                 |
| `app/tasks`     | Celery задачи (OCR, AI-анализ, уведомления).              | В связке с `worker.py`.                                                                   |
| `app/websocket` | Менеджер WebSocket-соединений (events, task status).      | Используем `fastapi.WebSocket` + Redis pub/sub.                                           |
| `tests/backend` | Pytest для API/сервисов.                                  | Фикстуры для временной БД и mock очередей.                                                |

#### Docker/Compose

| Файл/каталог                 | Что хранит                                                | Комментарий                                   |
| ---------------------------- | --------------------------------------------------------- | --------------------------------------------- |
| `docker/compose.yml`         | Сервисы (frontend, backend, worker, redis, postgres, pb). | Стейджинг/прод — один стек.                   |
| `docker/Dockerfile.frontend` | Сборка SvelteKit → node/alpine или static adapter.        | Build stage + nginx stage.                    |
| `docker/Dockerfile.backend`  | FastAPI + Uvicorn/Gunicorn.                               | Включаем poetry/pip, копируем `app/`.         |
| `docker/Dockerfile.worker`   | Celery worker/beat.                                       | Общая база с backend, отдельная CMD.          |
| `docker/.env.example`        | Все переменные окружения.                                 | Разделяем секции FRONTEND*/BACKEND*/DOCKER\_. |
| `docker/Makefile`            | Команды `make dev`, `make logs`, `make deploy`.           | Упрощает локальный и CI запуск.               |
| `deploy/infra/`              | Будущие IaC (Terraform, Ansible).                         | Можно заполнять по мере роста.                |

Принципы:

| Принцип       | Описание                                                                                                                                                             |
| ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Чистые слои   | UI → modules → repositories → services → API; контроллеры не импортируют компоненты/stores.                                                                          |
| Feature-first | Для крупных фич (Reminders, Spaces) отдельные папки с компонентами, сторами и сервисами.                                                                             |
| Middleware    | Общие функции в `src/lib/server/middleware`, подключаются в `hooks.server.ts`.                                                                                       |
| Shared utils  | Дробим `utils` на тематические файлы (`date.ts`, `string.ts`, `ai.ts`).                                                                                              |
| Типы          | Общие интерфейсы в `src/lib/types/*`, используем их во всех слоях.                                                                                                   |
| Testing       | Для каждой фичи — `__tests__` рядом или в `tests/feature`, чтобы повторять структуру.                                                                                |
| Frontend      | Страницам `src/routes` соответствуют фиче-модули; layout — `src/lib/components/layout`, UI — `src/lib/components/ui`.                                                |
| Компоненты    | `layout` — shell и общие блоки; `ui` — атомарные элементы; `modules/<feature>/components` — фичевые части; стили — `src/lib/styles`; избегаем безструктурной свалки. |

## 16. FastAPI WebSocket стек

| Уровень            | Практика / ссылка                                                                                                                                                             |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Сервер (FastAPI)   | Используем `@app.websocket("/ws")`, менеджер подключений (`ConnectionManager.connect/disconnect/broadcast`) для чатов/уведомлений; можно вынести в `server/middleware/ws.py`. |
| Клиент (Svelte 5)  | Создаём подключение только в браузере: проверяем `browser` из `$app/environment`, инициализируем `new WebSocket(...)` внутри `$effect`, сохраняем сообщения в `$state`.       |
| PWA/Service Worker | Можно держать одно WebSocket соединение через SW и расшаривать события между вкладками (MessageChannel), снижая нагрузку на сервер.                                           |
| Reconnect          | В `services/realtime.ts` реализуем экспоненциальный backoff + очередь сообщений на время оффлайна.                                                                            |
| FastAPI + Celery   | Для готовых результатов фоновых задач (OCR/ИИ) используем WebSocket-канал `task:{id}` — Celery по завершении отправляет итог в подключение.                                   |
| Документация       | Опираемся на практики из файла `в fastapi можно делать web sockets.md`: декораторы `@app.websocket`, класс менеджера, runes в Svelte 5.                                       |

## 17. PWA, Service Worker и оффлайн

| Блок              | Детали                                                                                                                                                                                                                                                                                                           |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PWA-сервис-воркер | Расширяем `src/service-worker.js`: web push + `notificationclick`, Background Sync (`sync/push`), кеширование статики и fallback для API.                                                                                                                                                                        |
| APK/Capacitor     | Используем `capacitor.config.ts`: камера/галерея (`@capacitor/camera`), push (`@capacitor/push-notifications` + `notification_tokens`), background/локальные уведомления (`@capacitor/local-notifications`), voice (`@capacitor-community/media`); добавляем `services/native` для bridge, учитываем разрешения. |
| Единая логика     | Независимо от платформы используем одинаковые API (`/sync`, `/ai`, `/reminders`), нативные фичи прячем за адаптерами `services/native`, чтобы фронт не зависел от среды.                                                                                                                                         |

### IndexedDB и оффлайн-режим

| Этап/слой           | Практика                                                                                                                    |
| ------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| Старт/синхронизация | При загрузке PWA вызываем `/api/sync?last=<timestamp>` → сохраняем дельты в IndexedDB (Dexie/idb).                          |
| Локальные CRUD      | Все действия в оффлайне пишутся в IndexedDB (таблицы `events`, `pending`). Optimistic UI обновляет Svelte stores мгновенно. |
| Очередь изменений   | Service Worker или foreground код добавляет записи в `pending_queue`; при событии `sync` отправляет батч на `/api/pending`. |
| Background Sync     | `navigator.serviceWorker.ready.then(reg => reg.sync.register('sync-pending'))` — отправка в момент появления сети.          |
| Конфликты           | Сервер хранит `version/updatedAt`; при рассинхронизации возвращает merge strategy (LWW или custom).                         |
| Инструменты         | `Dexie.js`/`idb` для удобного API, `workbox-background-sync` для Service Worker.                                            |
| UX                  | Показать индикатор “сохранено оффлайн” + статус синхронизации; хранить `sync_state` в store.                                |

## 18. Очереди и фоновые задачи (Celery/Redis)

| Компонент/блок       | Практика                                                                                                                                               |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Broker               | Redis в Docker Compose (`redis:alpine`) — очередь для Celery и кэш.                                                                                    |
| Workers              | Celery (`celery -A app.celery worker --loglevel=info`) обрабатывает OCR/ИИ/синк задачи; конфиг в `tasks.py`.                                           |
| Flower UI            | `mher/flower` или `celery -A app flower --port=5555` — мониторинг задач, воркеров, retry.                                                              |
| Интеграция с FastAPI | Endpoint создаёт задачу `task = process_photo.delay(...)` и возвращает `task_id`; клиент поллит `/task-status/{id}` или слушает WebSocket `task:{id}`. |
| BackgroundTasks      | Для лёгких действий (логирование, email) можно использовать FastAPI `BackgroundTasks`, но основные AI-операции идут через Celery.                      |
| Альтернативы         | RQ/Redis Queue как упрощённая версия; возможно использовать для небольших jobs.                                                                        |
| Deploy               | Docker Compose: `fastapi`, `redis`, `celery`, `flower`; логируем метрики задач в `telemetry`.                                                          |

## 19. Наблюдаемость, безопасность и DevOps

| Направление             | Практики                                                                                                                                                                                                                                                                                                                                       |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Мониторинг и логи       | Централизованный логгер (`src/lib/utils/logger`) → Logtail/Datadog (timestamp, level, requestId, userId/spaceId); `/api/ai/*`, `/api/billing/*`, `/api/reminders` пишут метрики в `telemetry`; health-check `/api/status` мониторит FastAPI/PostgreSQL/OpenRouter/очереди/storage; логи экспортируются в ClickHouse/BigQuery для длительного хранения. |
| Security/Privacy        | Все API требуют JWT/WebAuthn, refresh-токены в `users_sessions`; rate limiting per IP/user на уровне proxy + middleware; signed URLs с TTL для файлов; шифрование чувствительных данных (`PB_ENCRYPTION_KEY`); регулярные бэкапы и тесты восстановления, раздельные env для prod/staging.                                                      |
| CI/CD                   | GitHub Actions: lint/test → build → deploy + `npm run pb:setup`; service worker обновляется с `skipWaiting` и `PUBLIC_APP_VERSION`; APK workflow (`npx cap sync android && gradlew assemble`); secret-менеджмент через GitHub Environments/1Password.                                                                                          |
| QA и тестирование       | Unit-тесты для services/repositories, snapshot-тесты компонентов; E2E (Playwright/Cypress) для ключевых сценариев; отдельные тесты оффлайн-режима (Workbox) и PWA-install.                                                                                                                                                                     |
| Операционная готовность | RBAC в FastAPI/PostgreSQL (roles: owner/editor/viewer) + `activity_log`; инцидент-канал (Slack/Telegram) при 5xx/AI usage > 80%; регулярные security review (`npm audit`, PenTest чек-лист).                                                                                                                       |

## 20. UX-флоу: рецепты, поля, AI-помощник

### Рецепты и формы

| Слой/файл                                                | Что делает                                                                                                                  |
| -------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `src/lib/config/fields.ts`                               | Единый реестр всех полей (label, type, section, serialize, ограничения).                                                    |
| `src/lib/config/recipes.ts`                              | Default recipes: `form.fields`, `required`, `ai.extract`, `category`, `color`, `sortOrder`.                                 |
| `user_recipes` + `/api/recipes`                          | Пользовательские рецепты; включение/выключение через `recipe_settings`.                                                     |
| `src/routes/new/+page.svelte` + `RecipeEntryForm.svelte` | Визард, который строит форму по рецепту, переключает шаги (source→AI→form) и вызывает `createEntry`.                        |
| Fit/Usability                                            | Категории и иконки помогают найти сценарий; поля разделены на базовые/расширенные; подсказки показывают примеры заполнения. |

**Структура Recipe:** `id`, `action`, `object`, `label`, `icon`, `description`, `category`, `subcategory`, `color`, `enabled`, `sortOrder`, `form.fields`, `form.required`, `ai.mode`, `ai.extract`.  
**Структура Field:** `FieldId` + `FieldDef` (type, section, serialize, placeholder, isArray, min/max/step, aiKey).  
**Структура Entry:** см. `src/lib/types/entry.ts` — содержит `action`, `object`, `title`, `note`, `amount`, `category`, `status`, `date`, `people`, `placeText`, `geo`, `tags`, `attachments`, `extras`, `aiRaw`, `aiConfidence`, `created`, `updated`.

### Пайплайн создания и каталог

| Шаг                 | Подробности                                                                                                         |
| ------------------- | ------------------------------------------------------------------------------------------------------------------- |
| Выбор рецепта       | Страница визарда (`/new`) показывает категории и каталог (данные из `recipes.built.json` + `user_recipes`).         |
| Заполнение полей    | Каждое поле знает тип (Input, TagInput, GeoPicker). Вся логика сериализации централизована в `FieldDef`.            |
| Каналы добавления   | Визард (ручной ввод), свободный текст, фото, URL, повтор — см. таблицу “Пайплайн создания записей” выше.            |
| Каталог/справочники | API `GET /api/dictionaries/*` подставляет варианты (люди, теги, места).                                             |
| Финальный UX        | После сабмита запись локально сохраняется в IndexedDB (моментальный отклик), а сервер подтверждает и возвращает ID. |

### Экран `/new` — источники

| Источник/вариант  | Как работает                                                                                                        |
| ----------------- | ------------------------------------------------------------------------------------------------------------------- |
| Категории/рецепты | Карточки категорий (каталог), при выборе → `RecipeList`/`RecipeEntryForm`.                                          |
| Свободный текст   | Текстовое поле + кнопка “Понять текст”; вызывает `ai/analyze` → шаг `refine` или сразу `form`.                      |
| Фото/камера       | Компонент `AIFirstUpload` принимает файл/камеру; AI анализирует чек/товар → предлагает запись или шаг refine.       |
| URL               | Поле ввода ссылки + выбор `urlAction` (хочу купить/пойти/купил/понравилось/документ); `ai/analyze` парсит страницу. |
| Голос             | Используется Web Speech API (`recognition`) — диктуем текст, дальше как “свободный текст”.                          |
| Повтор/референс   | `POST /api/entries/replay` — выбираем готовую запись/рецепт из истории и дублируем с правками.                      |

### AI-коммуникация и помощь

| Сценарий     | UX-детали                                                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------- |
| Создание     | `ai/analyze` автозаполняет поля: пользователь видит предложенную карточку, может исправить и сохранить.                         |
| Каталог + AI | При импорте ссылок/товаров `ai/analyze` предлагает карточку товара (название, цена, фото), пользователь выбирает рецепт/группу. |
| Чат          | `/ai/chat` отвечает во втором лице (“ты”), возвращает `response` + `suggestedFilters` + `suggestedEntryIds`.                    |
| Поиск        | `/ai/search` отдаёт `response` + список ID/фильтров → список записей подсвечивается, можно сразу открыть карточку.              |
| Подсказки    | AI добавляет `clarifyingQuestions`, которые показываются кнопками; пользователь может нажать, чтобы уточнить запрос.            |

### Observability UX

| Что видит продакт | Где смотреть                                                                               |
| ----------------- | ------------------------------------------------------------------------------------------ |
| Каталог и рецепты | Визард (UI) + `/api/recipes` (можно выгрузить JSON), логирование включений рецептов.       |
| Статус AI задач   | Flower (очереди), `/task-status/{id}` API, WebSocket `task:{id}` → UI показывает progress. |
| Синхронизация     | `sync_state` store отображает “Онлайн/Оффлайн, ожидают X записей” — данные из IndexedDB.   |

## 21. Docker и деплой на VM

| Сервис/контейнер     | Назначение                                    | Dockerfile/образ                                        |
| -------------------- | --------------------------------------------- | ------------------------------------------------------- |
| `frontend`           | Сборка и отдача SvelteKit PWA                 | `docker/Dockerfile.frontend`                            |
| `backend`            | API/данные (FastAPI + Celery)                | `docker/Dockerfile.backend`                              |
| `postgres`           | Основная БД                                   | `postgres:16-alpine`                                    |
| `redis`              | Брокер Celery, кэш                            | `redis:alpine`                                          |
| `celery`             | Фоновые задачи (OCR, AI, синк pending)        | Образ backend + команда `celery -A ...`                 |
| `flower`             | UI-мониторинг очередей                        | `mher/flower`                                           |
| `nginx`/`caddy`      | Реверс-прокси, TLS, статика                   | `nginx:alpine` или `caddy`                              |

План:

1. `docker/compose.yml` поднимает все сервисы с томами (`postgres-data`, `pocketbase-data`, `redis-data`) и использует общий `.env`.
2. CI/CD: GitHub Actions собирает образы `frontend`/`backend`, пушит в Registry, затем на VM выполняется `docker compose pull && docker compose up -d`.
3. Бэкапы: скрипты в `docker/scripts` (или `scripts/`) для `pg_dump` и snapshot’ов object storage; расписание `cron` на VM.
4. Локальный запуск: `docker compose up` из каталога `docker/`, `.env.example` содержит все переменные (API URL, ключи, Redis, Postgres).
