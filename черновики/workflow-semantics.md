# Семантика Workflow создания записи

## Общая структура

**Формула:** `Entry = Action + Object + Context`

**Workflow:** `source → (text|photo|url|refine) → form → success`

---

## Состояния (Steps)

### 1. `source` - Выбор источника

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Выберите категорию или способ добавления"

**Элементы:**

- **Ссылка** - "Вставьте ссылку на товар или услугу" (icon: Link2)
- **Текст** - "Напишите или наговорите текст" (icon: Type)
- **Категории** - сетка 2 колонки с категориями из recipes
- **Кнопка:** "Сканировать фото/чек" (sticky bottom, icon: Camera)

**Действия:**

- `handleURLSelect()` → `step = 'url'`, `cameFromAI = true`
- `handleTextSelect()` → `step = 'text'`, `cameFromAI = true`
- `handlePhotoSelect()` → `step = 'photo'`, `cameFromAI = true`
- `handleCategorySelect(category)` → `step = 'refine'`, `cameFromCategory = true`

---

### 2. `text` - Ввод текста

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Введите текст для анализа"
**Прогресс:** `2/{totalSteps}`

**Элементы:**

- Textarea: placeholder "Например: Потратил 500 рублей на такси сегодня утром"
- Кнопка: "Распознать с ИИ" (icon: Sparkles) / "Анализ..." (icon: Loader2, disabled)

**Действия:**

- `handleTextAnalyze()` → POST `/api/ai/analyze` с `text`
- Если несколько записей → `step = 'multiple'`
- Если одна запись → `handleAISuccess()` → `step = 'form'` или `'refine'`

**Семантика:**

- AI анализирует текст без подсказок (hintType)
- Результат: `AIAnalysisResult` с `action`, `object`, `tags`

---

### 3. `photo` - Загрузка фото

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Загрузите фото, скриншот или чек"
**Прогресс:** `2/{totalSteps}`

**Элементы:**

- `AIFirstUpload` компонент: "Загрузите фото, скриншот или чек"
- **6 категорий намерений:**
  1. **Покупка** - "я это уже оплатил сейчас" (icon: ShoppingCart, id: `purchase`)
  2. **Перевод** - "я отправил деньги другому человеку" (icon: Handshake, id: `transfer`)
  3. **Хочу купить** - "думаю о покупке в будущем" (icon: Heart, id: `want_buy`)
  4. **Хочу пойти** - "думаю о месте или событии" (icon: MapPin, id: `want_go`)
  5. **Понравилось** - "был опыт, который мне зашёл" (icon: Star, id: `liked`)
  6. **Документ** - "важно сохранить как факт или справку" (icon: FileText, id: `document`)
- Поле комментария: "Добавьте комментарий или сумму, если нужно"
  - Подсказка: "Например: что именно на чеке, сумма, комментарий или категория"
- Кнопка: "Распознать с ИИ" (icon: Sparkles) / "Анализ..." (icon: Loader2)

**Действия:**

- `handlePhotoAnalyze()` → POST `/api/ai/analyze` с:
  - `file` (File)
  - `hintType` (маппинг из `photoAction`):
    - `purchase` → `'bought'`
    - `transfer` → `'spent'`
    - `want_buy` → `'planned'`
    - `want_go` → `'planned'`
    - `liked` → `'noted'`
    - `document` → `'noted'`
  - `customDescription` (если заполнено)

**Семантика:**

- Пользователь выбирает **намерение** перед анализом
- AI получает подсказку о типе действия
- Результат: `AIAnalysisResult` + `attachments = [file]`

---

### 4. `url` - Ввод ссылки

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Введите ссылку"
**Прогресс:** `2/{totalSteps}`

**Элементы:**

- Input URL (серый фон `bg-muted`): placeholder "https://ozon.ru/product/..."
- **5 категорий намерений:**
  1. **Хочу купить** - "думаю о покупке в будущем" (icon: Heart, id: `want_buy`)
  2. **Хочу пойти** - "думаю о месте или событии" (icon: MapPin, id: `want_go`)
  3. **Покупка** - "я это уже оплатил сейчас" (icon: ShoppingCart, id: `bought`)
  4. **Понравилось** - "был опыт, который мне зашёл" (icon: Star, id: `liked`)
  5. **Документ** - "важно сохранить как факт или справку" (icon: FileText, id: `document`)
- Поле описания: "Своими словами"
  - Подсказка: "Например: кафе, куда хочу сходить • товар для ремонта • статья про здоровье • идея подарка"
- Кнопка: "Распознать с ИИ" (icon: Sparkles) / "Анализ..." (icon: Loader2)

**Действия:**

- `handleURLAnalyze()` → POST `/api/ai/analyze` с:
  - `url` (string)
  - `hintType` (маппинг из `urlAction`):
    - `want_buy` → `'planned'`
    - `want_go` → `'planned'`
    - `bought` → `'bought'`
    - `liked` → `'noted'`
    - `document` → `'noted'`
  - `customDescription` (если заполнено)

**Семантика:**

- Пользователь выбирает **намерение** перед анализом
- AI получает подсказку + описание своими словами
- Результат: `AIAnalysisResult`

---

### 5. `refine` - Уточнение типа записи

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Выберите тип записи"
**Прогресс:** `2/{totalSteps}` или `3/{totalSteps}` (зависит от пути)

**Элементы:**

- Список рецептов из выбранной категории
- Каждый рецепт: `RecipeCard` с `label`, `description`, `icon`
- Сортировка: по `sortOrder` из JSON

**Действия:**

- `handleRecipeSelect(recipe)` → `step = 'form'`, `selectedRecipe = recipe`

**Семантика:**

- Показывается, если:
  - AI не нашел точный рецепт → определяет категорию из `result.object`
  - Пользователь выбрал категорию вручную
- Маппинг `object` → `category`:
  - `money` → `'money'`
  - `item` → `'items'`
  - `place` → `'places'`
  - `food` → `'food'`
  - `service` → `'services'`
  - `wish`/`task` → `'wishes'`
  - `note` → `'notes'` или `'experience'` (по тегам)

---

### 6. `form` - Форма заполнения

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Заполните все данные"
**Прогресс:** `3/{totalSteps}` или `4/{totalSteps}`

**Элементы:**

- `RecipeEntryForm` компонент
- Принимает: `recipe`, `attachments`, `aiResult`
- Заполняет: `EntryFormData` (action, object, title, amount, date, etc.)

**Действия:**

- `handleSubmit(data)` → `createEntry(data, attachments, aiData)`
- Успех → `toast.success('Запись создана')` → `goto('/')`
- Ошибка → `toast.error(...)`

**Семантика:**

- Финальный шаг перед сохранением
- AI результат используется для автозаполнения
- Валидация обязательных полей

---

### 7. `multiple` - Множественные записи

**Заголовок:** "Что запишем?"
**Подзаголовок:** "Заполните данные ({currentMultipleIndex + 1} из {multipleAIResults.length})"
**Прогресс:** `3/{totalSteps}` или `4/{totalSteps}`

**Элементы:**

- То же, что `form`, но с индикатором прогресса
- После сохранения → переход к следующей записи

**Действия:**

- После `handleSubmit()` → `currentMultipleIndex++` → `handleMultipleAISuccess(nextResult)`
- Когда все записи обработаны → `goto('/')`

**Семантика:**

- Используется, когда AI распознал несколько записей из текста
- Каждая запись обрабатывается отдельно

---

## Пути (Paths)

### Path 1: Категория → Рецепт → Форма

```
source → refine → form
```

**Шаги:** 3
**Флаги:** `cameFromCategory = true`, `cameFromAI = false`

---

### Path 2: AI (текст/фото/URL) → Форма (AI нашел рецепт)

```
source → (text|photo|url) → form
```

**Шаги:** 3
**Флаги:** `cameFromAI = true`, `cameFromCategory = false`, `selectedCategory = null`

**Условие:** `getRecipeBySemantic(result.action, result.object)` вернул рецепт

---

### Path 3: AI → Уточнение → Форма (AI не нашел рецепт)

```
source → (text|photo|url) → refine → form
```

**Шаги:** 4
**Флаги:** `cameFromAI = true`, `selectedCategory != null`

**Условие:** `getRecipeBySemantic()` вернул `null`, но определил категорию

---

### Path 4: Прямой доступ (URL параметр)

```
?recipe=xxx → form
```

**Шаги:** 2
**Флаги:** `cameFromCategory = false`, `cameFromAI = false`

---

## Семантические маппинги

### PhotoAction → Semantic Action

```typescript
{
  purchase: 'bought',      // купил
  transfer: 'spent',        // потратил (перевод)
  want_buy: 'planned',      // планирую купить
  want_go: 'planned',       // планирую пойти
  liked: 'noted',           // отметил/понравилось
  document: 'noted'         // документ/факт
}
```

### UrlAction → Semantic Action

```typescript
{
  want_buy: 'planned',      // планирую купить
  want_go: 'planned',       // планирую пойти
  bought: 'bought',         // купил
  liked: 'noted',            // отметил/понравилось
  document: 'noted'          // документ/факт
}
```

### AI Object → Recipe Category (базовая категория)

```typescript
{
  'money' → 'money',        // Деньги
  'item' → 'items',         // Вещи
  'place' → 'places',       // Места
  'food' → 'food',          // Еда
  'service' → 'services',   // Услуги
  'wish' | 'task' → 'wishes', // Желания
  'note' → 'notes' | 'experience' (по тегам + намерению) // Заметки или Опыт
  // Fallback: если объект не определен → используется намерение
  // Финальный fallback: 'other'
}
```

**Важно:** Это маппинг определяет, в какую **базовую категорию recipes** попадет запись, если AI не нашел точный рецепт. Затем показываются все рецепты из этой категории на шаге `refine`.

**Логика определения категории (функция `determineCategoryFromAIResult()`):**

1. Прямой маппинг `object` → `category` (если есть)
2. Специальные случаи (`wish`/`task` → `wishes`)
3. Для `note`: проверка тегов + намерения (если намерение "Понравилось", больше вероятность `experience`)
4. Fallback: использование намерения для уточнения категории
5. Финальный fallback: `'other'`

---

## Связь: Намерения → Базовые категории

### Теоретическая модель

**6 категорий намерений** (PhotoAction/UrlAction) → это **входные данные** для AI  
**Базовые категории recipes** (money, items, places, etc.) → это **группировка рецептов** для выбора

### Как это работает:

1. **Пользователь выбирает намерение** (например, "Покупка" или "Хочу купить")
2. **AI получает подсказку** (`hintType`) и анализирует контент
3. **AI определяет:**
   - `action` (bought, planned, noted, spent, received)
   - `object` (money, item, place, food, service, etc.)
4. **Система пытается найти точный рецепт:** `getRecipeBySemantic(action, object)`
5. **Если рецепт найден** → сразу `form` с этим рецептом
6. **Если рецепт не найден** → определяет базовую категорию из `object` → показывает все рецепты из этой категории на `refine`

### Примеры связи:

#### Намерение: "Покупка" (`purchase`)

- **hintType:** `'bought'`
- **Возможные объекты AI:** `money`, `item`, `service`
- **Базовые категории:** `money`, `items`, `services`
- **Рецепты:** "Расход", "Покупка товара", "Оплата услуги"

#### Намерение: "Перевод" (`transfer`)

- **hintType:** `'spent'`
- **Возможные объекты AI:** `money`
- **Базовые категории:** `money`
- **Рецепты:** "Перевод", "Долг", "Вернул деньги"

#### Намерение: "Хочу купить" (`want_buy`)

- **hintType:** `'planned'`
- **Возможные объекты AI:** `item`, `service`
- **Базовые категории:** `items`, `services`, `wishes`
- **Рецепты:** "Хочу купить", "План покупки", "Желание"

#### Намерение: "Хочу пойти" (`want_go`)

- **hintType:** `'planned'`
- **Возможные объекты AI:** `place`
- **Базовые категории:** `places`, `wishes`
- **Рецепты:** "Хочу сходить", "План посещения", "Желание"

#### Намерение: "Понравилось" (`liked`)

- **hintType:** `'noted'`
- **Возможные объекты AI:** `food`, `place`, `item`, `note`
- **Базовые категории:** `food`, `places`, `items`, `experience`, `notes`
- **Рецепты:** "Понравилось блюдо", "Понравилось место", "Впечатление", "Заметка"

#### Намерение: "Документ" (`document`)

- **hintType:** `'noted'`
- **Возможные объекты AI:** `money`, `service`, `note`
- **Базовые категории:** `money`, `services`, `notes`
- **Рецепты:** "Квитанция", "Справка", "Документ", "Заметка"

### Важно понимать:

1. **Намерения ≠ Базовые категории**
   - Намерения — это **причина действия** (зачем сохраняю)
   - Базовые категории — это **группировка рецептов** (что это по типу)

2. **AI определяет базовую категорию из `object`**
   - Не из намерения напрямую
   - Намерение помогает AI лучше понять контекст

3. **Базовые категории — это шлюз к рецептам**
   - Если AI не нашел точный рецепт → показывает все рецепты из категории
   - Пользователь выбирает конкретный рецепт на шаге `refine`

4. **Рецепт = финальная форма записи**
   - Рецепт определяет: какие поля показывать, как AI должен работать
   - Рецепт имеет `action + object` из семантического ядра

---

## Тексты интерфейса

### Заголовки и подзаголовки

- **Главный заголовок:** "Что запишем?"
- **Подзаголовки по шагам:**
  - `source`: "Выберите категорию или способ добавления"
  - `text`: "Введите текст для анализа"
  - `photo`: "Загрузите фото, скриншот или чек"
  - `url`: "Введите ссылку"
  - `refine`: "Выберите тип записи"
  - `form`: "Заполните все данные"
  - `multiple`: "Заполните данные (X из Y)"

### Кнопки

- **Сканировать фото/чек** (source, sticky bottom)
- **Распознать с ИИ** / **Анализ...** (text, photo, url)

### Placeholders

- Textarea: "Например: Потратил 500 рублей на такси сегодня утром"
- URL Input: "https://ozon.ru/product/..."
- Комментарий фото: "Добавьте комментарий или сумму, если нужно"
- Описание URL: "Своими словами"

### Подсказки

- Фото комментарий: "Например: что именно на чеке, сумма, комментарий или категория"
- URL описание: "Например: кафе, куда хочу сходить • товар для ремонта • статья про здоровье • идея подарка"

### Toast сообщения

- **Успех:**
  - "AI распознал запись"
  - "Запись создана"
- **Ошибки:**
  - "Введите текст для анализа"
  - "Загрузите фото"
  - "Введите ссылку"
  - "Некорректная ссылка"
  - "Ошибка анализа текста"
  - "Ошибка анализа фото"
  - "Ошибка анализа ссылки"
  - "Заполните все обязательные поля"
  - "Ошибка валидации данных"
  - "Ошибка создания записи: {errorMessage}"

---

## Логика намерений (Intent)

### 6 категорий намерений для фото/URL:

1. **Покупка** (`purchase`/`bought`)
   - Вопрос: "Я это уже оплатил?"
   - Семантика: `action: 'bought'`
   - Примеры: чек, оплата, услуга

2. **Перевод** (`transfer`)
   - Вопрос: "Это деньги между людьми?"
   - Семантика: `action: 'spent'`
   - Примеры: скрин банка, долг, перевод

3. **Хочу купить** (`want_buy`)
   - Вопрос: "Это про деньги в будущем?"
   - Семантика: `action: 'planned'`
   - Примеры: ценник, товар, идея покупки

4. **Хочу пойти** (`want_go`)
   - Вопрос: "Это про место или событие?"
   - Семантика: `action: 'planned'`
   - Примеры: кафе, бар, адрес, афиша

5. **Понравилось** (`liked`)
   - Вопрос: "Это был опыт?"
   - Семантика: `action: 'noted'`
   - Примеры: еда, место, вещь, момент

6. **Документ** (`document`)
   - Вопрос: "Это просто важно сохранить?"
   - Семантика: `action: 'noted'`
   - Примеры: квитанции, талоны, справки

---

## Навигация назад

### Из `form`/`multiple`:

- Если `selectedCategory` → `refine`
- Если `cameFromAI` → определяет шаг (photo/url/text)
- Иначе → `source`

### Из `refine`:

- Если `cameFromAI` → определяет шаг (photo/url/text)
- Иначе → `source`

### Из `text`/`photo`/`url`:

- → `source` (сброс всех данных)

---

## Состояния загрузки

- `analyzingText` - анализ текста
- `analyzingPhoto` - анализ фото
- `analyzingUrl` - анализ URL

Все кнопки блокируются во время анализа.

---

## Прогресс-бар

- Показывается на всех шагах кроме `source`
- `progress = (currentStep / totalSteps) * 100`
- `currentStep` и `totalSteps` вычисляются динамически в зависимости от пути

---

## Особенности

1. **Множественные записи:** AI может распознать несколько записей из одного текста
2. **Автоопределение категории:** AI пытается определить категорию из `object`, затем маппится на базовую категорию recipes. Используется функция `determineCategoryFromAIResult()`, которая учитывает:
   - Прямой маппинг object → category
   - Теги для уточнения (например, для `note` → `experience` vs `notes`)
   - Намерение пользователя как дополнительный сигнал (если доступно)
   - Fallback на `'other'` для неизвестных объектов. Используется функция `determineCategoryFromAIResult()`, которая учитывает:
   - Прямой маппинг object → category
   - Теги для уточнения (например, для `note` → `experience` vs `notes`)
   - Намерение пользователя как дополнительный сигнал
   - Fallback на `'other'` для неизвестных объектов
3. **Подсказки для AI:** Пользователь выбирает намерение перед анализом (photo/url) → передается как `hintType`
4. **Кастомные описания:** Пользователь может добавить описание своими словами → передается как `customDescription`
5. **Прикрепления:** Фото сохраняется как attachment к записи
6. **AI результат:** Сохраняется в `aiData` для истории и улучшения
7. **Двухуровневая система:**
   - **Уровень 1:** Намерения (6 категорий) → помогают AI понять контекст
   - **Уровень 2:** Базовые категории recipes (12 категорий) → группируют рецепты для выбора
   - **Уровень 3:** Рецепты → финальная форма записи с конкретным `action + object`

---

## Базовые категории Recipes

Система базируется на **12 базовых категориях** из конфигурации recipes:

1. **money** (Деньги) — денежные операции
2. **items** (Вещи) — покупки, подарки, обмен
3. **places** (Места) — посещения, путешествия
4. **food** (Еда) — прием пищи, покупки еды
5. **services** (Услуги) — оплата, подписки
6. **wishes** (Желания) — планы и цели
7. **notes** (Заметки) — общие записи
8. **experience** (Опыт) — впечатления, переживания
9. **sport** (Спорт) — тренировки, соревнования
10. **hobby** (Хобби) — увлечения и творчество
11. **media** (Медиа) — медиа и контент
12. **other** (Прочее) — прочие записи

### Как используются:

- **В шаге `source`:** Показываются как карточки категорий для ручного выбора
- **В шаге `refine`:** Показываются рецепты из выбранной категории
- **После AI анализа:** Если рецепт не найден, определяется категория из `object` → показываются рецепты из этой категории

### Связь с намерениями:

Намерения **не заменяют** базовые категории, а **дополняют** их:

- Намерения помогают AI лучше понять контекст
- Базовые категории группируют рецепты для финального выбора
- Рецепт определяет финальную форму записи
